syntax = "proto3";

package as;

// ApplicationServer is the server to be implemented by the application server.
service ApplicationServer {
	// JoinRequest requests the application server to validate the join-request and return an encrypted join-accept.
	rpc JoinRequest(JoinRequestRequest) returns (JoinRequestResponse) {}

    // PublishDataUp publishes data received from an end-device.
    rpc PublishDataUp(PublishDataUpRequest) returns (PublishDataUpResponse) {}

	// GetDataDown gets data from the downlink queue.
	rpc GetDataDown(GetDataDownRequest) returns (GetDataDownResponse) {}

    // PublishDataDownACK publishes a data-down ack response.
    rpc PublishDataDownACK(PublishDataDownACKRequest) returns (PublishDataDownACKResponse) {}

    // PublishError publishes an error message.
    rpc PublishError(PublishErrorRequest) returns (PublishErrorResponse) {}
}

enum RXWindow {
    RX1 = 0;
    RX2 = 1;
}

enum ErrorType {
	Generic = 0;
	OTAA = 1;
	DATA_UP_FCNT = 2;
	DATA_UP_MIC = 3;
}

message DataRate {
    string modulation = 1;
    uint32 bandWidth = 2;
    uint32 spreadFactor = 3;
    uint32 bitrate = 4;
}

message RXInfo {
    bytes mac = 1;
    string time = 2;
    int32 rssi = 3;
    double loRaSNR = 4;
}

message TXInfo {
    int64 frequency = 1;
    DataRate dataRate = 2;
    bool adr = 3;
    string codeRate = 4;
}

message JoinRequestRequest {
	bytes phyPayload = 1;
	bytes devAddr = 2;
	bytes netID = 3;
}

message JoinRequestResponse {
	bytes phyPayload = 1;
	bytes nwkSKey = 2;
	uint32 rxDelay = 3;
	uint32 rx1DROffset = 4;
	repeated uint32 cFList = 5;
    RXWindow rxWindow = 6;
    uint32 rx2DR = 7;
}

message PublishDataUpRequest {
    bytes devEUI = 1;
    uint32 fCnt = 2;
	uint32 fPort = 3;
    bytes data = 4;
    TXInfo txInfo = 5;
    repeated RXInfo rxInfo = 6;
}

message GetDataDownRequest {
	bytes devEUI = 1;
	uint32 maxPayloadSize = 2;
	uint32 fCnt = 3;
}

message GetDataDownResponse {
	bytes data = 1;
	bool confirmed = 2;
	uint32 fPort = 3;
	bool moreData = 4;
}

message PublishDataUpResponse {}

message PublishDataDownACKRequest {
    bytes devEUI = 1;
	uint32 fCnt = 2;
}

message PublishDataDownACKResponse {}

message PublishErrorRequest {
    bytes devEUI = 1;
	ErrorType type = 2;
    string error = 3;
}

message PublishErrorResponse {}
